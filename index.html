<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MWSS RO Â· Harmonized Client Satisfaction Measurement (HCSM) Dashboard</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(165deg, #f0f8fc 0%, #e4f0f5 100%);
            padding: 2rem 2rem;
            color: #063b47;
        }

        .dashboard {
            max-width: 1800px;
            margin: 0 auto;
        }

        .hero {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 48px;
            padding: 2.2rem 2.8rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0, 70, 90, 0.06);
            border: 1px solid rgba(255,255,255,0.7);
        }

        h1 {
            font-weight: 800;
            font-size: 2.4rem;
            background: linear-gradient(145deg, #0e5a6b, #12809b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
            margin-bottom: 0.7rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .subhead {
            font-size: 1rem;
            color: #1e6a7a;
            font-weight: 500;
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(18,128,155,0.12);
            padding: 0.3rem 1.2rem;
            border-radius: 60px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #0e6579;
            border: 1px solid rgba(18,128,155,0.2);
        }

        .toggle-lead {
            display: flex;
            justify-content: center;
            margin-bottom: 2.5rem;
        }

        .service-switch {
            background: white;
            padding: 0.6rem;
            border-radius: 100px;
            display: inline-flex;
            box-shadow: 0 15px 30px rgba(0,70,90,0.08);
            border: 1px solid rgba(147,197,214,0.3);
        }

        .switch-btn {
            padding: 1rem 3rem;
            border: none;
            background: transparent;
            border-radius: 60px;
            font-weight: 700;
            font-size: 1.1rem;
            color: #1f6277;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch-btn.active {
            background: #0f859e;
            color: white;
            box-shadow: 0 8px 16px rgba(15,133,158,0.3);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }

        @media (max-width: 1000px) {
            .chart-grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.8rem; }
            .switch-btn { padding: 0.8rem 1.8rem; }
        }

        .chart-panel {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 40px;
            padding: 2rem 2rem;
            box-shadow: 0 15px 30px rgba(0,70,90,0.04);
            border: 1px solid rgba(255,255,255,0.8);
            display: flex;
            flex-direction: column;
            transition: 0.2s;
        }

        .chart-panel:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,90,110,0.08);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid rgba(15,133,158,0.15);
            padding-bottom: 1rem;
        }

        .chart-header h2 {
            font-weight: 700;
            font-size: 1.3rem;
            color: #0e4f60;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-header i {
            color: #0f859e;
            font-size: 1.3rem;
        }

        .total-indicator {
            background: rgba(15,133,158,0.1);
            padding: 0.4rem 1.2rem;
            border-radius: 60px;
            font-weight: 600;
            font-size: 0.8rem;
            color: #0b657b;
        }

        canvas {
            max-height: 220px;
            width: 100%;
            margin: 0.5rem 0 1rem;
        }

        .data-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem 1.5rem;
            margin-top: 0.8rem;
            font-size: 0.85rem;
            color: #1f6a7c;
            background: rgba(15,133,158,0.05);
            padding: 1rem 1.5rem;
            border-radius: 28px;
            font-weight: 500;
            border: 1px solid rgba(15,133,158,0.1);
        }

        .data-legend span {
            font-weight: 700;
            color: #0a4b5a;
        }

        .live-banner {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 60px;
            padding: 1.2rem 2rem;
            margin-bottom: 2rem;
            color: #155724;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-footer {
            margin-top: 3rem;
            text-align: center;
            font-size: 0.9rem;
            color: #347b8a;
            padding: 1.5rem;
            border-top: 1px solid rgba(79,142,157,0.2);
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            background: rgba(255,255,255,0.4);
            border-radius: 60px;
        }

        .live-badge {
            background: #d1ecf0;
            padding: 0.4rem 1.6rem;
            border-radius: 60px;
            font-weight: 600;
        }

        .cell-ref {
            font-family: 'Courier New', monospace;
            background: #e3f0f5;
            padding: 0.1rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
<div class="dashboard">

    <!-- HERO: MWSS RO Harmonized Client Satisfaction Measurement (HCSM) Dashboard -->
    <div class="hero">
        <h1>
            <i class="fas fa-chart-pie" style="-webkit-text-fill-color: #0f859e;"></i> 
            MWSS RO Â· HCSM
        </h1>
        <div class="subhead">
            <span><i class="fas fa-clipboard-check"></i> Harmonized Client Satisfaction Measurement</span>
            <span class="badge"><i class="fas fa-table"></i> Cell References: B42, C42, F34-F41, F18-F21, H26-H29, F47-F51, F57-F62, F68-F72</span>
            <span class="badge"><i class="fas fa-robot"></i> Google Apps Script Bridge Â· LIVE</span>
        </div>
    </div>

    <!-- LIVE CONNECTION BANNER - YOUR WEB APP IS EMBEDDED AND ACTIVE -->
    <div class="live-banner" id="liveBanner">
        <i class="fas fa-check-circle" style="font-size: 1.8rem; color: #28a745;"></i>
        <div style="flex:1">
            <strong style="font-size: 1.1rem;">âœ… APPS SCRIPT BRIDGE ACTIVE â€” CONNECTED TO LIVE SHEETS</strong><br>
            <span>Web App URL: <span style="font-family: monospace; background: #fff; padding: 0.2rem 0.8rem; border-radius: 40px;">https://script.google.com/macros/s/AKfycbzq9txNtrgWH1EkO9uYDKEDbi8hjuHz-HexUYvxXJEbG4oMFv941GUNw65sCqaE2Fym/exec</span></span>
        </div>
    </div>

    <!-- SERVICE TYPE TOGGLE - EXTERNAL / INTERNAL / OVERALL -->
    <div class="toggle-lead">
        <div class="service-switch" id="serviceToggle">
            <button class="switch-btn active" data-type="overall"><i class="fas fa-globe-americas"></i> OVERALL</button>
            <button class="switch-btn" data-type="external"><i class="fas fa-external-link-square-alt"></i> EXTERNAL</button>
            <button class="switch-btn" data-type="internal"><i class="fas fa-building"></i> INTERNAL</button>
        </div>
    </div>

    <!-- CHART GRID - 7 CHARTS WITH FULL DESCRIPTIONS (NO SHORTCUTS) -->
    <div class="chart-grid" id="chartGrid">
        <!-- Charts will be injected by JavaScript -->
    </div>

    <!-- STATUS FOOTER -->
    <div class="status-footer">
        <span class="live-badge" id="liveStatus"><i class="fas fa-spinner fa-pulse"></i> Connecting to live sheets...</span>
        <span><i class="fas fa-cell"></i> Exact cell references preserved â€” NO SHORTCUTS</span>
        <span><i class="fas fa-chart-bar"></i> 7 Infographics Â· Full CC1/CC2/CC3 descriptions</span>
    </div>

</div>

<script>
    (function() {
        "use strict";

        // ============================================================
        // ðŸ”´ YOUR GOOGLE APPS SCRIPT WEB APP URL - EMBEDDED AND READY
        // ============================================================
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzq9txNtrgWH1EkO9uYDKEDbi8hjuHz-HexUYvxXJEbG4oMFv941GUNw65sCqaE2Fym/exec";
        
        // ============================================================
        // GLOBAL STATE
        // ============================================================
        let currentService = 'overall';
        let chartInstances = {};
        const gridEl = document.getElementById('chartGrid');
        const liveStatus = document.getElementById('liveStatus');

        // ----- FETCH SHEET DATA VIA JSONP (100% COMPATIBLE WITH APPS SCRIPT) -----
        async function fetchSheetData(sheetType) {
            return new Promise((resolve) => {
                try {
                    liveStatus.innerHTML = `<i class="fas fa-spinner fa-pulse"></i> Fetching ${sheetType.toUpperCase()} sheet from Apps Script...`;
                    
                    const callbackName = `jsonp_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
                    const url = `${APPS_SCRIPT_URL}?sheet=${sheetType}&callback=${callbackName}&t=${Date.now()}`;
                    
                    // Set timeout fallback
                    const timeout = setTimeout(() => {
                        cleanup();
                        liveStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Timeout - using sample data`;
                        resolve(generateSampleMatrix(sheetType));
                    }, 15000);
                    
                    function cleanup() {
                        clearTimeout(timeout);
                        if (window[callbackName]) {
                            delete window[callbackName];
                        }
                        const script = document.querySelector(`script[src*="${callbackName}"]`);
                        if (script) script.remove();
                    }
                    
                    // JSONP callback function
                    window[callbackName] = function(response) {
                        cleanup();
                        
                        if (response && response.success === true && response.data) {
                            liveStatus.innerHTML = `<i class="fas fa-check-circle"></i> Live: ${sheetType.toUpperCase()} Â· ${response.rows || ''} rows loaded`;
                            const matrix = parseCSVtoMatrix(response.data);
                            resolve(matrix);
                        } else {
                            console.error('API Error:', response);
                            liveStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${response?.error || 'Unknown'}. Using sample data.`;
                            resolve(generateSampleMatrix(sheetType));
                        }
                    };
                    
                    // Create script tag for JSONP
                    const script = document.createElement('script');
                    script.src = url;
                    script.onerror = function() {
                        cleanup();
                        liveStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Network error - using sample data`;
                        resolve(generateSampleMatrix(sheetType));
                    };
                    
                    document.head.appendChild(script);
                    
                } catch (e) {
                    console.error('JSONP Error:', e);
                    liveStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error - using sample data`;
                    resolve(generateSampleMatrix(sheetType));
                }
            });
        }

        // ----- PARSE CSV TO MATRIX (handles quotes, commas, line breaks) -----
        function parseCSVtoMatrix(csvText) {
            if (!csvText || typeof csvText !== 'string') return generateSampleMatrix('overall');
            
            const lines = csvText.split(/\r?\n/).filter(l => l.trim() !== '');
            const matrix = [];
            
            lines.forEach(line => {
                const row = [];
                let inQuotes = false;
                let current = '';
                
                for (let char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current.trim());
                matrix.push(row.map(cell => cell.replace(/^"|"$/g, '')));
            });
            
            return matrix;
        }

        // ----- GET CELL VALUE (B42, F34, etc.) -----
        function getCellValue(matrix, cellRef) {
            if (!matrix || matrix.length === 0) return 0;
            
            try {
                const colLetter = cellRef.match(/[A-Z]+/)[0];
                const rowNum = parseInt(cellRef.match(/\d+/)[0], 10);
                
                let colIndex = 0;
                for (let i = 0; i < colLetter.length; i++) {
                    colIndex = colIndex * 26 + (colLetter.charCodeAt(i) - 64);
                }
                colIndex -= 1;
                const rowIndex = rowNum - 1;
                
                if (matrix[rowIndex] && matrix[rowIndex][colIndex] !== undefined) {
                    const val = matrix[rowIndex][colIndex];
                    const num = parseFloat(val.replace(/[^\d.-]/g, ''));
                    return isNaN(num) ? 0 : num;
                }
            } catch (e) {}
            return 0;
        }

        // ----- SAMPLE DATA (YOUR EXACT CELL STRUCTURE) -----
        function generateSampleMatrix(type) {
            const m = [];
            for (let i = 0; i < 100; i++) m[i] = [];
            
            // SEX DISAGGREGATED DATA - B42, C42
            m[41] = m[41] || []; 
            m[41][1] = type === 'external' ? 124 : type === 'internal' ? 98 : 222; // Male
            m[41][2] = type === 'external' ? 146 : type === 'internal' ? 72 : 218; // Female
            
            // AGE DISTRIBUTION - F34:F41
            m[33] = m[33] || []; m[33][5] = 2;  // N/S
            m[34] = m[34] || []; m[34][5] = 18; // 19 and below
            m[35] = m[35] || []; m[35][5] = 67; // 20-29
            m[36] = m[36] || []; m[36][5] = 81; // 30-39
            m[37] = m[37] || []; m[37][5] = 54; // 40-49
            m[38] = m[38] || []; m[38][5] = 38; // 50-59
            m[39] = m[39] || []; m[39][5] = 22; // 60-69
            m[40] = m[40] || []; m[40][5] = 10; // 70 and above
            
            // CLIENT TYPE - F18:F21
            m[17] = m[17] || []; m[17][5] = 5;   // N/S
            m[18] = m[18] || []; m[18][5] = type === 'external' ? 187 : type === 'internal' ? 64 : 251; // Citizen
            m[19] = m[19] || []; m[19][5] = type === 'external' ? 62 : type === 'internal' ? 43 : 105; // Business
            m[20] = m[20] || []; m[20][5] = type === 'external' ? 21 : type === 'internal' ? 63 : 84;  // Government
            
            // CLIENT BY REGION - H26:H29
            m[25] = m[25] || []; m[25][7] = 4;   // N/S
            m[26] = m[26] || []; m[26][7] = 78;  // Region III
            m[27] = m[27] || []; m[27][7] = 94;  // Region IV-A
            m[28] = m[28] || []; m[28][7] = 112; // NCR
            
            // CC1 AWARENESS - F47:F51
            m[46] = m[46] || []; m[46][5] = 6;   // N/S
            m[47] = m[47] || []; m[47][5] = 103; // I know what a CC is and I saw this officeâ€™s CC
            m[48] = m[48] || []; m[48][5] = 47;  // I know what a CC is but I did NOT see this officeâ€™s CC
            m[49] = m[49] || []; m[49][5] = 58;  // I learned of the CC only when I saw this officeâ€™s CC
            m[50] = m[50] || []; m[50][5] = 32;  // I do not know what a CC is and I did not see one in this office
            
            // CC2 VISIBILITY - F57:F62
            m[56] = m[56] || []; m[56][5] = 7;   // N/S
            m[57] = m[57] || []; m[57][5] = 89;  // Easy to see
            m[58] = m[58] || []; m[58][5] = 52;  // Somewhat easy to see
            m[59] = m[59] || []; m[59][5] = 23;  // Difficult to see
            m[60] = m[60] || []; m[60][5] = 14;  // Not visible at all
            m[61] = m[61] || []; m[61][5] = 41;  // N/A
            
            // CC3 EFFECTIVITY - F68:F72
            m[67] = m[67] || []; m[67][5] = 5;   // N/S
            m[68] = m[68] || []; m[68][5] = 112; // Helped very much
            m[69] = m[69] || []; m[69][5] = 58;  // Somewhat helped
            m[70] = m[70] || []; m[70][5] = 16;  // Did not helped
            m[71] = m[71] || []; m[71][5] = 27;  // N/A
            
            return m;
        }

        // ----- RENDER DASHBOARD WITH 7 CHARTS -----
        async function renderDashboard() {
            // Show loading state
            gridEl.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 4rem; background: white; border-radius: 40px;">
                    <i class="fas fa-spinner fa-pulse" style="font-size: 2rem; color: #0f859e;"></i>
                    <p style="margin-top: 1rem; color: #0f859e; font-weight: 600;">Loading ${currentService.toUpperCase()} data from Google Sheets...</p>
                </div>
            `;

            const matrix = await fetchSheetData(currentService);
            if (!matrix) return;

            // ----- 1. SEX DISAGGREGATED DATA -----
            const male = getCellValue(matrix, 'B42');
            const female = getCellValue(matrix, 'C42');
            const totalSex = male + female;

            // ----- 2. AGE DISTRIBUTION -----
            const ageNS = getCellValue(matrix, 'F34');
            const age19b = getCellValue(matrix, 'F35');
            const age2029 = getCellValue(matrix, 'F36');
            const age3039 = getCellValue(matrix, 'F37');
            const age4049 = getCellValue(matrix, 'F38');
            const age5059 = getCellValue(matrix, 'F39');
            const age6069 = getCellValue(matrix, 'F40');
            const age70 = getCellValue(matrix, 'F41');
            const totalAge = ageNS + age19b + age2029 + age3039 + age4049 + age5059 + age6069 + age70;

            // ----- 3. CLIENT TYPE -----
            const clientNS = getCellValue(matrix, 'F18');
            const citizen = getCellValue(matrix, 'F19');
            const business = getCellValue(matrix, 'F20');
            const government = getCellValue(matrix, 'F21');
            const totalClient = clientNS + citizen + business + government;

            // ----- 4. CLIENT BY REGION -----
            const regionNS = getCellValue(matrix, 'H26');
            const region3 = getCellValue(matrix, 'H27');
            const region4a = getCellValue(matrix, 'H28');
            const ncr = getCellValue(matrix, 'H29');
            const totalRegion = regionNS + region3 + region4a + ncr;

            // ----- 5. CITIZEN'S CHARTER AWARENESS (CC1) -----
            const cc1NS = getCellValue(matrix, 'F47');
            const knowSaw = getCellValue(matrix, 'F48');
            const knowNotSaw = getCellValue(matrix, 'F49');
            const learned = getCellValue(matrix, 'F50');
            const dontKnow = getCellValue(matrix, 'F51');
            const totalCC1 = cc1NS + knowSaw + knowNotSaw + learned + dontKnow;
            const awareDenom = totalCC1 - dontKnow - cc1NS || 1;

            // ----- 6. CITIZEN'S CHARTER VISIBILITY (CC2) -----
            const cc2NS = getCellValue(matrix, 'F57');
            const easy = getCellValue(matrix, 'F58');
            const somewhatEasy = getCellValue(matrix, 'F59');
            const difficult = getCellValue(matrix, 'F60');
            const notVisible = getCellValue(matrix, 'F61');
            const cc2na = getCellValue(matrix, 'F62');

            // ----- 7. CITIZEN'S CHARTER EFFECTIVITY (CC3) -----
            const cc3NS = getCellValue(matrix, 'F68');
            const helpedMuch = getCellValue(matrix, 'F69');
            const somewhatHelped = getCellValue(matrix, 'F70');
            const didNotHelp = getCellValue(matrix, 'F71');
            const cc3na = getCellValue(matrix, 'F72');

            // ----- BUILD HTML WITH FULL DESCRIPTIONS (NO SHORTCUTS) -----
            let html = '';

            // CARD 1: SEX DISAGGREGATED DATA
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-venus-mars"></i> Sex Disaggregated Data (SDD) by Service Type</h2>
                    <span class="total-indicator">Total: ${totalSex}</span>
                </div>
                <canvas id="chartSex"></canvas>
                <div class="data-legend">
                    <span>Male:</span> ${male} (${totalSex ? ((male/totalSex)*100).toFixed(1) : 0}%) 
                    <span>Female:</span> ${female} (${totalSex ? ((female/totalSex)*100).toFixed(1) : 0}%)
                    <span class="cell-ref">B42, C42</span>
                </div>
            </div>`;

            // CARD 2: AGE DISTRIBUTION
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-calendar-alt"></i> Age Distribution by Service Type</h2>
                    <span class="total-indicator">Total: ${totalAge}</span>
                </div>
                <canvas id="chartAge"></canvas>
                <div class="data-legend">
                    <div style="width: 100%;">
                        <span>Not Specified (N/S):</span> ${ageNS} Â· <span>19 and below:</span> ${age19b}<br>
                        <span>20-29:</span> ${age2029} Â· <span>30-39:</span> ${age3039} Â· <span>40-49:</span> ${age4049}<br>
                        <span>50-59:</span> ${age5059} Â· <span>60-69:</span> ${age6069} Â· <span>70 and above:</span> ${age70}
                    </div>
                    <span class="cell-ref">F34-F41</span>
                </div>
            </div>`;

            // CARD 3: CLIENT TYPE
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-users"></i> Client Type by Service</h2>
                    <span class="total-indicator">Total: ${totalClient}</span>
                </div>
                <canvas id="chartClient"></canvas>
                <div class="data-legend">
                    <div style="width: 100%;">
                        <span>Not Specified (N/S):</span> ${clientNS}<br>
                        <span>Citizen (Mamamayan):</span> ${citizen}<br>
                        <span>Business (Negosyo):</span> ${business}<br>
                        <span>Government (Gobyerno):</span> ${government}
                    </div>
                    <span class="cell-ref">F18-F21</span>
                </div>
            </div>`;

            // CARD 4: CLIENT BY REGION
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-map-marker-alt"></i> Client by Region</h2>
                    <span class="total-indicator">Total: ${totalRegion}</span>
                </div>
                <canvas id="chartRegion"></canvas>
                <div class="data-legend">
                    <div style="width: 100%;">
                        <span>Not Specified (N/S):</span> ${regionNS}<br>
                        <span>Region III:</span> ${region3}<br>
                        <span>Region IV-A:</span> ${region4a}<br>
                        <span>NCR:</span> ${ncr}
                    </div>
                    <span class="cell-ref">H26-H29</span>
                </div>
            </div>`;

            // CARD 5: CITIZEN'S CHARTER AWARENESS (CC1)
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-eye"></i> Citizen's Charter Awareness</h2>
                    <span class="total-indicator">Total: ${totalCC1}</span>
                </div>
                <canvas id="chartCC1"></canvas>
                <div class="data-legend">
                    <div style="width: 100%;">
                        <span>Not Specified (N/S):</span> ${cc1NS}<br>
                        <span>I know what a CC is and I saw this officeâ€™s CC:</span> ${knowSaw}<br>
                        <span>I know what a CC is but I did NOT see this officeâ€™s CC:</span> ${knowNotSaw}<br>
                        <span>I learned of the CC only when I saw this officeâ€™s CC:</span> ${learned}<br>
                        <span>I do not know what a CC is and I did not see one in this office (Answer â€˜N/Aâ€™ on CC2 and CC3):</span> ${dontKnow}
                    </div>
                    <span class="cell-ref">F47-F51</span>
                </div>
            </div>`;

            // CARD 6: CITIZEN'S CHARTER VISIBILITY (CC2)
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-low-vision"></i> Citizen's Charter Visibility</h2>
                    <span class="total-indicator">Aware respondents: ${awareDenom}</span>
                </div>
                <canvas id="chartCC2"></canvas>
                <div class="data-legend">
                    <div style="width: 100%;">
                        <span>Not Specified (N/S):</span> ${cc2NS}<br>
                        <span>Easy to see:</span> ${easy}<br>
                        <span>Somewhat easy to see:</span> ${somewhatEasy}<br>
                        <span>Difficult to see:</span> ${difficult}<br>
                        <span>Not visible at all:</span> ${notVisible}<br>
                        <span>N/A (Not Applicable):</span> ${cc2na}
                    </div>
                    <span class="cell-ref">F57-F62</span>
                </div>
            </div>`;

            // CARD 7: CITIZEN'S CHARTER EFFECTIVITY (CC3)
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-check-circle"></i> Citizen's Charter Effectivity</h2>
                    <span class="total-indicator">Aware respondents: ${awareDenom}</span>
                </div>
                <canvas id="chartCC3"></canvas>
                <div class="data-legend">
                    <div style="width: 100%;">
                        <span>Not Specified (N/S):</span> ${cc3NS}<br>
                        <span>Helped very much:</span> ${helpedMuch}<br>
                        <span>Somewhat helped:</span> ${somewhatHelped}<br>
                        <span>Did not helped:</span> ${didNotHelp}<br>
                        <span>N/A (Not Applicable):</span> ${cc3na}
                    </div>
                    <span class="cell-ref">F68-F72</span>
                </div>
            </div>`;

            gridEl.innerHTML = html;

            // ----- DESTROY OLD CHARTS -----
            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
            chartInstances = {};

            // ----- CREATE NEW CHARTS -----
            
            // Chart 1: Sex (Doughnut)
            chartInstances.sex = new Chart(document.getElementById('chartSex'), {
                type: 'doughnut',
                data: {
                    labels: ['Male', 'Female'],
                    datasets: [{
                        data: [male, female],
                        backgroundColor: ['#2f98b3', '#f193b0'],
                        borderWidth: 0,
                        borderRadius: 8
                    }]
                },
                options: {
                    cutout: '65%',
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: true
                }
            });

            // Chart 2: Age (Bar)
            chartInstances.age = new Chart(document.getElementById('chartAge'), {
                type: 'bar',
                data: {
                    labels: ['N/S', '19â†“', '20-29', '30-39', '40-49', '50-59', '60-69', '70â†‘'],
                    datasets: [{
                        data: [ageNS, age19b, age2029, age3039, age4049, age5059, age6069, age70],
                        backgroundColor: '#1f9ab3',
                        borderRadius: 6
                    }]
                },
                options: {
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#cde3ec' }
                        } 
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Chart 3: Client Type (Doughnut)
            chartInstances.client = new Chart(document.getElementById('chartClient'), {
                type: 'doughnut',
                data: {
                    labels: ['Citizen', 'Business', 'Government', 'N/S'],
                    datasets: [{
                        data: [citizen, business, government, clientNS],
                        backgroundColor: ['#53b5c9', '#a1d2d4', '#3f8f9c', '#b0d3da'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '65%',
                    plugins: { legend: { display: false } }
                }
            });

            // Chart 4: Region (Pie)
            chartInstances.region = new Chart(document.getElementById('chartRegion'), {
                type: 'pie',
                data: {
                    labels: ['Region III', 'Region IV-A', 'NCR', 'N/S'],
                    datasets: [{
                        data: [region3, region4a, ncr, regionNS],
                        backgroundColor: ['#58a7b5', '#7ec8d3', '#2f8a9b', '#b4d5db'],
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: { legend: { display: false } }
                }
            });

            // Chart 5: CC1 Awareness (Bar)
            chartInstances.cc1 = new Chart(document.getElementById('chartCC1'), {
                type: 'bar',
                data: {
                    labels: ['Know & Saw', 'Know/Not Saw', 'Learned', 'Don\'t know', 'N/S'],
                    datasets: [{
                        data: [knowSaw, knowNotSaw, learned, dontKnow, cc1NS],
                        backgroundColor: ['#147a8f', '#3ba3b9', '#5fb3c5', '#c1dce2', '#e2eef0'],
                        borderRadius: 6
                    }]
                },
                options: {
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#cde3ec' }
                        } 
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Chart 6: CC2 Visibility (Bar)
            chartInstances.cc2 = new Chart(document.getElementById('chartCC2'), {
                type: 'bar',
                data: {
                    labels: ['Easy', 'Somewhat', 'Difficult', 'Not visible', 'N/A', 'N/S'],
                    datasets: [{
                        data: [easy, somewhatEasy, difficult, notVisible, cc2na, cc2NS],
                        backgroundColor: ['#179f9b', '#57b8b0', '#e5989b', '#b8b2b2', '#b0b0b0', '#d9d9d9'],
                        borderRadius: 6
                    }]
                },
                options: {
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#cde3ec' }
                        } 
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Chart 7: CC3 Effectivity (Bar)
            chartInstances.cc3 = new Chart(document.getElementById('chartCC3'), {
                type: 'bar',
                data: {
                    labels: ['Helped much', 'Somewhat', 'Did not help', 'N/A', 'N/S'],
                    datasets: [{
                        data: [helpedMuch, somewhatHelped, didNotHelp, cc3na, cc3NS],
                        backgroundColor: ['#148f6d', '#51b192', '#e0a38d', '#b3b3b3', '#d4d4d4'],
                        borderRadius: 6
                    }]
                },
                options: {
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#cde3ec' }
                        } 
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // ----- TOGGLE EVENT LISTENERS -----
        function initEvents() {
            document.querySelectorAll('.switch-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.switch-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentService = this.dataset.type;
                    renderDashboard();
                });
            });
        }

        // ----- START THE DASHBOARD -----
        window.addEventListener('DOMContentLoaded', () => {
            initEvents();
            renderDashboard();
        });
    })();
</script>
</body>
</html>
