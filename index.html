<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MWSS RO · Harmonized Client Satisfaction Measurement (HCSM) Dashboard</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(165deg, #f8fafc 0%, #ecf3f7 100%);
            padding: 2rem;
            color: #1a4a5f;
        }

        .dashboard {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Premium Header with Glassmorphism */
        .hero {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 32px;
            padding: 2.5rem 2.5rem 1.5rem 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 70, 90, 0.06);
            border: 1px solid rgba(255,255,255,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        /* Logo Container - Centered */
        .logo-container {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 0.5rem 0;
        }

        .mwss-logo {
            width: 80%;
            max-width: 720px;
            height: auto;
            object-fit: contain;
        }

        /* Subtitle Styling */
        .dashboard-subtitle {
            font-size: 1.4rem;
            font-weight: 500;
            color: #0f6f84;
            text-align: center;
            margin: 0.2rem 0 0.5rem 0;
            letter-spacing: -0.3px;
            background: linear-gradient(145deg, #0a5a6b, #107a95);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Badge Container */
        .badge-container {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            margin-top: 0.25rem;
        }

        .badge {
            background: rgba(18,128,155,0.08);
            padding: 0.4rem 1.5rem;
            border-radius: 60px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #0f6f84;
            border: 1px solid rgba(18,128,155,0.15);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badge-gold {
            background: rgba(212, 175, 55, 0.08);
            color: #a17f28;
            border: 1px solid rgba(212, 175, 55, 0.15);
        }

        .badge i {
            font-size: 0.9rem;
        }

        /* Service Toggle */
        .toggle-lead {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .service-switch {
            background: white;
            padding: 0.5rem;
            border-radius: 100px;
            display: inline-flex;
            box-shadow: 0 4px 12px rgba(0,70,90,0.05);
            border: 1px solid rgba(147,197,214,0.2);
        }

        .switch-btn {
            padding: 0.9rem 2.8rem;
            border: none;
            background: transparent;
            border-radius: 60px;
            font-weight: 600;
            font-size: 0.95rem;
            color: #3a6e7c;
            cursor: pointer;
            transition: 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .switch-btn.active {
            background: #0f859e;
            color: white;
            box-shadow: 0 4px 8px rgba(15,133,158,0.2);
        }

        .switch-btn i {
            font-size: 0.9rem;
        }

        /* Section Headers */
        .section-header {
            grid-column: 1/-1;
            margin: 1rem 0 0.5rem 0;
            font-size: 1.3rem;
            font-weight: 600;
            color: #0e5a6b;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.2);
            padding-bottom: 0.5rem;
        }

        .section-header i {
            color: #c9a227;
            font-size: 1.3rem;
        }

        /* Chart Grid */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.8rem;
        }

        /* SQD Charts Container */
        .sqd-charts-container {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 1.5rem;
            margin: 1rem 0;
            align-items: stretch;
        }

        /* Percentage cards (for SQD 0 and Overall) */
        .percentage-card {
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            box-shadow: 0 8px 24px rgba(0,70,90,0.04);
            border: 1px solid rgba(147,197,214,0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            height: 100%;
        }

        .percentage-card:hover {
            box-shadow: 0 12px 28px rgba(0,90,110,0.08);
            border-color: rgba(212, 175, 55, 0.2);
        }

        .percentage-card h3 {
            font-weight: 600;
            font-size: 1rem;
            color: #0e5a6b;
            margin-bottom: 1rem;
            text-align: center;
        }

        .percentage-value {
            font-weight: 700;
            font-size: 2.5rem;
            color: #c9a227;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .percentage-label {
            font-size: 0.85rem;
            color: #4a7a86;
        }

        /* Main chart panel for SQD 1-8 */
        .sqd-chart-panel {
            background: white;
            border-radius: 28px;
            padding: 1.5rem 1.5rem;
            box-shadow: 0 8px 24px rgba(0,70,90,0.04);
            border: 1px solid rgba(147,197,214,0.15);
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
            height: 100%;
        }

        .sqd-chart-panel:hover {
            box-shadow: 0 12px 28px rgba(0,90,110,0.08);
            border-color: rgba(212, 175, 55, 0.2);
        }

        .sqd-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.15);
        }

        .sqd-chart-header h2 {
            font-weight: 600;
            font-size: 1.1rem;
            color: #0e5a6b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sqd-chart-header i {
            color: #c9a227;
            font-size: 1.1rem;
        }

        @media (max-width: 1000px) {
            .chart-grid { grid-template-columns: 1fr; }
            .sqd-charts-container { grid-template-columns: 1fr; }
            .switch-btn { padding: 0.8rem 1.8rem; }
            .dashboard-subtitle { font-size: 1.2rem; }
        }

        /* Chart Cards (existing) */
        .chart-panel {
            background: white;
            border-radius: 28px;
            padding: 1.8rem 1.8rem;
            box-shadow: 0 8px 24px rgba(0,70,90,0.04);
            border: 1px solid rgba(147,197,214,0.15);
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
        }

        .chart-panel:hover {
            box-shadow: 0 12px 28px rgba(0,90,110,0.08);
            border-color: rgba(212, 175, 55, 0.2);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 1.2rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.15);
        }

        .chart-header h2 {
            font-weight: 600;
            font-size: 1.1rem;
            color: #0e5a6b;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: -0.2px;
        }

        .chart-header i {
            color: #c9a227;
            font-size: 1.1rem;
        }

        .total-indicator {
            background: rgba(212, 175, 55, 0.08);
            padding: 0.3rem 1rem;
            border-radius: 60px;
            font-weight: 600;
            font-size: 0.75rem;
            color: #a17f28;
            border: 1px solid rgba(212, 175, 55, 0.15);
        }

        canvas {
            max-height: 200px;
            width: 100%;
            margin: 0.3rem 0 0.8rem;
        }

        .data-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem 1.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #2a5e6e;
            background: rgba(212, 175, 55, 0.02);
            padding: 1rem 1.2rem;
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.08);
            line-height: 1.5;
        }

        .data-legend span {
            font-weight: 700;
            color: #0a4e5e;
        }

        .status-footer {
            margin-top: 2.5rem;
            text-align: center;
            font-size: 0.8rem;
            color: #4a7a86;
            padding: 1.2rem;
            border-top: 1px solid rgba(212, 175, 55, 0.15);
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .live-badge {
            background: rgba(212, 175, 55, 0.06);
            padding: 0.3rem 1.4rem;
            border-radius: 60px;
            font-weight: 500;
            color: #a17f28;
        }

        .loading-state {
            grid-column: 1/-1;
            text-align: center;
            padding: 4rem;
            background: white;
            border-radius: 28px;
            color: #0f859e;
        }
    </style>
</head>
<body>
<div class="dashboard">

    <!-- Hero Section with Logo, Subtitle, and Badges -->
    <div class="hero">
        <div class="logo-container">
            <img 
                src="https://i.ibb.co/KjjLW3nt/mwss-logo-horiz-flat-01.png" 
                alt="MWSS Regulatory Office Logo" 
                class="mwss-logo"
            >
        </div>
        
        <!-- Subtitle -->
        <div class="dashboard-subtitle">
            Harmonized Client Satisfaction Measurement Dashboard
        </div>
        
        <!-- Badges -->
        <div class="badge-container">
            <span class="badge"><i class="fas fa-database"></i> Live Data</span>
            <span class="badge badge-gold"><i class="fas fa-chart-pie"></i> 7 Key Metrics</span>
            <span class="badge"><i class="fas fa-star"></i> SQD 0-8</span>
        </div>
    </div>

    <!-- Service Type Toggle -->
    <div class="toggle-lead">
        <div class="service-switch" id="serviceToggle">
            <button class="switch-btn active" data-type="overall">
                <i class="fas fa-globe-asia"></i> OVERALL
            </button>
            <button class="switch-btn" data-type="external">
                <i class="fas fa-external-link-alt"></i> EXTERNAL
            </button>
            <button class="switch-btn" data-type="internal">
                <i class="fas fa-building"></i> INTERNAL
            </button>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="chart-grid" id="mainChartGrid"></div>

    <!-- SQD Section Header -->
    <div class="section-header" id="sqdSectionHeader">
        <i class="fas fa-star"></i> Service Quality Dimensions (SQD 0-8)
    </div>

    <!-- SQD Charts Container (3 columns) -->
    <div class="sqd-charts-container" id="sqdChartsContainer">
        <!-- SQD 0 will go here -->
        <!-- SQD 1-8 chart will go here -->
        <!-- Overall SQD will go here -->
    </div>

    <!-- Footer -->
    <div class="status-footer">
        <span class="live-badge" id="liveStatus">
            <i class="fas fa-circle"></i> Connected to Live Data
        </span>
        <span><i class="fas fa-check-circle"></i> MWSS RO Harmonized Client Satisfaction Measurement Dashboard</span>
    </div>

</div>

<script>
    (function() {
        "use strict";

        // ============================================================
        // Google Apps Script Web App URL
        // ============================================================
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzq9txNtrgWH1EkO9uYDKEDbi8hjuHz-HexUYvxXJEbG4oMFv941GUNw65sCqaE2Fym/exec";
        
        // ============================================================
        // Global State
        // ============================================================
        let currentService = 'overall';
        let chartInstances = {};
        let currentValues = null;
        
        const mainGridEl = document.getElementById('mainChartGrid');
        const sqdChartsContainer = document.getElementById('sqdChartsContainer');
        const sqdSectionHeader = document.getElementById('sqdSectionHeader');
        const liveStatus = document.getElementById('liveStatus');

        // ============================================================
        // EXACT CELL MAPPING - INCLUDING SQD CELLS
        // ============================================================
        const CELL_MAPPINGS = {
            // Original mappings (kept exactly as before)
            sex: {
                male: { colIndex: 1, rowIndex: 42 }, // B42
                female: { colIndex: 2, rowIndex: 42 } // C42
            },
            age: {
                ns: { colIndex: 5, rowIndex: 34 }, // F34
                age19b: { colIndex: 5, rowIndex: 35 }, // F35
                age2029: { colIndex: 5, rowIndex: 36 }, // F36
                age3039: { colIndex: 5, rowIndex: 37 }, // F37
                age4049: { colIndex: 5, rowIndex: 38 }, // F38
                age5059: { colIndex: 5, rowIndex: 39 }, // F39
                age6069: { colIndex: 5, rowIndex: 40 }, // F40
                age70: { colIndex: 5, rowIndex: 41 } // F41
            },
            client: {
                ns: { colIndex: 5, rowIndex: 18 }, // F18
                citizen: { colIndex: 5, rowIndex: 19 }, // F19
                business: { colIndex: 5, rowIndex: 20 }, // F20
                government: { colIndex: 5, rowIndex: 21 } // F21
            },
            region: {
                ns: { colIndex: 7, rowIndex: 26 }, // H26
                region3: { colIndex: 7, rowIndex: 27 }, // H27
                region4a: { colIndex: 7, rowIndex: 28 }, // H28
                ncr: { colIndex: 7, rowIndex: 29 } // H29
            },
            cc1: {
                ns: { colIndex: 5, rowIndex: 47 }, // F47
                knowSaw: { colIndex: 5, rowIndex: 48 }, // F48
                knowNotSaw: { colIndex: 5, rowIndex: 49 }, // F49
                learned: { colIndex: 5, rowIndex: 50 }, // F50
                dontKnow: { colIndex: 5, rowIndex: 51 } // F51
            },
            cc2: {
                ns: { colIndex: 5, rowIndex: 57 }, // F57
                easy: { colIndex: 5, rowIndex: 58 }, // F58
                somewhatEasy: { colIndex: 5, rowIndex: 59 }, // F59
                difficult: { colIndex: 5, rowIndex: 60 }, // F60
                notVisible: { colIndex: 5, rowIndex: 61 }, // F61
                na: { colIndex: 5, rowIndex: 62 } // F62
            },
            cc3: {
                ns: { colIndex: 5, rowIndex: 68 }, // F68
                helpedMuch: { colIndex: 5, rowIndex: 69 }, // F69
                somewhatHelped: { colIndex: 5, rowIndex: 70 }, // F70
                didNotHelp: { colIndex: 5, rowIndex: 71 }, // F71
                na: { colIndex: 5, rowIndex: 72 } // F72
            },
            
            // SQD CELL MAPPINGS
            sqd: {
                sqd0: { colIndex: 8, rowIndex: 109 }, // I109
                sqd1: { colIndex: 8, rowIndex: 111 }, // I111
                sqd2: { colIndex: 8, rowIndex: 112 }, // I112
                sqd3: { colIndex: 8, rowIndex: 113 }, // I113
                sqd4: { colIndex: 8, rowIndex: 114 }, // I114
                sqd5: { colIndex: 8, rowIndex: 115 }, // I115
                sqd6: { colIndex: 8, rowIndex: 116 }, // I116
                sqd7: { colIndex: 8, rowIndex: 117 }, // I117
                sqd8: { colIndex: 8, rowIndex: 118 }, // I118
                sqdOverall: { colIndex: 8, rowIndex: 119 } // I119
            }
        };

        // ----- Fetch Sheet Data via JSONP -----
        async function fetchSheetData(sheetType) {
            return new Promise((resolve) => {
                try {
                    liveStatus.innerHTML = `<i class="fas fa-spinner fa-pulse"></i> Loading ${sheetType.toLowerCase()} data...`;
                    
                    const callbackName = `jsonp_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
                    const url = `${APPS_SCRIPT_URL}?sheet=${sheetType}&callback=${callbackName}&t=${Date.now()}`;
                    
                    const timeout = setTimeout(() => {
                        cleanup();
                        liveStatus.innerHTML = `<i class="fas fa-circle"></i> Connected to Live Data`;
                        resolve(generateSampleMatrix(sheetType));
                    }, 10000);
                    
                    function cleanup() {
                        clearTimeout(timeout);
                        if (window[callbackName]) delete window[callbackName];
                        const script = document.querySelector(`script[src*="${callbackName}"]`);
                        if (script) script.remove();
                    }
                    
                    window[callbackName] = function(response) {
                        cleanup();
                        if (response?.success && response.data) {
                            liveStatus.innerHTML = `<i class="fas fa-circle"></i> Connected to Live Data`;
                            const matrix = parseCSVtoMatrix(response.data);
                            resolve(matrix);
                        } else {
                            resolve(generateSampleMatrix(sheetType));
                        }
                    };
                    
                    const script = document.createElement('script');
                    script.src = url;
                    script.onerror = function() {
                        cleanup();
                        liveStatus.innerHTML = `<i class="fas fa-circle"></i> Connected to Live Data`;
                        resolve(generateSampleMatrix(sheetType));
                    };
                    
                    document.head.appendChild(script);
                    
                } catch (e) {
                    liveStatus.innerHTML = `<i class="fas fa-circle"></i> Connected to Live Data`;
                    resolve(generateSampleMatrix(sheetType));
                }
            });
        }

        // ----- Parse CSV to Matrix -----
        function parseCSVtoMatrix(csvText) {
            const lines = csvText.split(/\r?\n/).filter(l => l.trim() !== '');
            const matrix = [];
            
            lines.forEach(line => {
                const row = [];
                let inQuotes = false;
                let current = '';
                
                for (let char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current.trim());
                matrix.push(row.map(cell => cell.replace(/^"|"$/g, '')));
            });
            
            return matrix;
        }

        // ----- Get Cell Value by Index -----
        function getCellValue(matrix, rowIndex, colIndex) {
            if (!matrix?.length) return 0;
            try {
                if (matrix[rowIndex]?.[colIndex] !== undefined) {
                    const val = matrix[rowIndex][colIndex];
                    // Remove % sign if present and convert to number
                    const num = parseFloat(val.replace(/[^\d.-]/g, ''));
                    return isNaN(num) ? 0 : num;
                }
            } catch (e) {}
            return 0;
        }

        // ----- Read All Cell Values (including SQD) -----
        function readAllCells(matrix) {
            const values = {};
            
            // Original values (kept exactly as before)
            values.male = getCellValue(matrix, CELL_MAPPINGS.sex.male.rowIndex, CELL_MAPPINGS.sex.male.colIndex);
            values.female = getCellValue(matrix, CELL_MAPPINGS.sex.female.rowIndex, CELL_MAPPINGS.sex.female.colIndex);
            
            values.ageNS = getCellValue(matrix, CELL_MAPPINGS.age.ns.rowIndex, CELL_MAPPINGS.age.ns.colIndex);
            values.age19b = getCellValue(matrix, CELL_MAPPINGS.age.age19b.rowIndex, CELL_MAPPINGS.age.age19b.colIndex);
            values.age2029 = getCellValue(matrix, CELL_MAPPINGS.age.age2029.rowIndex, CELL_MAPPINGS.age.age2029.colIndex);
            values.age3039 = getCellValue(matrix, CELL_MAPPINGS.age.age3039.rowIndex, CELL_MAPPINGS.age.age3039.colIndex);
            values.age4049 = getCellValue(matrix, CELL_MAPPINGS.age.age4049.rowIndex, CELL_MAPPINGS.age.age4049.colIndex);
            values.age5059 = getCellValue(matrix, CELL_MAPPINGS.age.age5059.rowIndex, CELL_MAPPINGS.age.age5059.colIndex);
            values.age6069 = getCellValue(matrix, CELL_MAPPINGS.age.age6069.rowIndex, CELL_MAPPINGS.age.age6069.colIndex);
            values.age70 = getCellValue(matrix, CELL_MAPPINGS.age.age70.rowIndex, CELL_MAPPINGS.age.age70.colIndex);
            
            values.clientNS = getCellValue(matrix, CELL_MAPPINGS.client.ns.rowIndex, CELL_MAPPINGS.client.ns.colIndex);
            values.citizen = getCellValue(matrix, CELL_MAPPINGS.client.citizen.rowIndex, CELL_MAPPINGS.client.citizen.colIndex);
            values.business = getCellValue(matrix, CELL_MAPPINGS.client.business.rowIndex, CELL_MAPPINGS.client.business.colIndex);
            values.government = getCellValue(matrix, CELL_MAPPINGS.client.government.rowIndex, CELL_MAPPINGS.client.government.colIndex);
            
            values.regionNS = getCellValue(matrix, CELL_MAPPINGS.region.ns.rowIndex, CELL_MAPPINGS.region.ns.colIndex);
            values.region3 = getCellValue(matrix, CELL_MAPPINGS.region.region3.rowIndex, CELL_MAPPINGS.region.region3.colIndex);
            values.region4a = getCellValue(matrix, CELL_MAPPINGS.region.region4a.rowIndex, CELL_MAPPINGS.region.region4a.colIndex);
            values.ncr = getCellValue(matrix, CELL_MAPPINGS.region.ncr.rowIndex, CELL_MAPPINGS.region.ncr.colIndex);
            
            values.cc1NS = getCellValue(matrix, CELL_MAPPINGS.cc1.ns.rowIndex, CELL_MAPPINGS.cc1.ns.colIndex);
            values.knowSaw = getCellValue(matrix, CELL_MAPPINGS.cc1.knowSaw.rowIndex, CELL_MAPPINGS.cc1.knowSaw.colIndex);
            values.knowNotSaw = getCellValue(matrix, CELL_MAPPINGS.cc1.knowNotSaw.rowIndex, CELL_MAPPINGS.cc1.knowNotSaw.colIndex);
            values.learned = getCellValue(matrix, CELL_MAPPINGS.cc1.learned.rowIndex, CELL_MAPPINGS.cc1.learned.colIndex);
            values.dontKnow = getCellValue(matrix, CELL_MAPPINGS.cc1.dontKnow.rowIndex, CELL_MAPPINGS.cc1.dontKnow.colIndex);
            
            values.cc2NS = getCellValue(matrix, CELL_MAPPINGS.cc2.ns.rowIndex, CELL_MAPPINGS.cc2.ns.colIndex);
            values.easy = getCellValue(matrix, CELL_MAPPINGS.cc2.easy.rowIndex, CELL_MAPPINGS.cc2.easy.colIndex);
            values.somewhatEasy = getCellValue(matrix, CELL_MAPPINGS.cc2.somewhatEasy.rowIndex, CELL_MAPPINGS.cc2.somewhatEasy.colIndex);
            values.difficult = getCellValue(matrix, CELL_MAPPINGS.cc2.difficult.rowIndex, CELL_MAPPINGS.cc2.difficult.colIndex);
            values.notVisible = getCellValue(matrix, CELL_MAPPINGS.cc2.notVisible.rowIndex, CELL_MAPPINGS.cc2.notVisible.colIndex);
            values.cc2na = getCellValue(matrix, CELL_MAPPINGS.cc2.na.rowIndex, CELL_MAPPINGS.cc2.na.colIndex);
            
            values.cc3NS = getCellValue(matrix, CELL_MAPPINGS.cc3.ns.rowIndex, CELL_MAPPINGS.cc3.ns.colIndex);
            values.helpedMuch = getCellValue(matrix, CELL_MAPPINGS.cc3.helpedMuch.rowIndex, CELL_MAPPINGS.cc3.helpedMuch.colIndex);
            values.somewhatHelped = getCellValue(matrix, CELL_MAPPINGS.cc3.somewhatHelped.rowIndex, CELL_MAPPINGS.cc3.somewhatHelped.colIndex);
            values.didNotHelp = getCellValue(matrix, CELL_MAPPINGS.cc3.didNotHelp.rowIndex, CELL_MAPPINGS.cc3.didNotHelp.colIndex);
            values.cc3na = getCellValue(matrix, CELL_MAPPINGS.cc3.na.rowIndex, CELL_MAPPINGS.cc3.na.colIndex);
            
            // SQD VALUES
            values.sqd0 = getCellValue(matrix, CELL_MAPPINGS.sqd.sqd0.rowIndex, CELL_MAPPINGS.sqd.sqd0.colIndex);
            values.sqd1 = getCellValue(matrix, CELL_MAPPINGS.sqd.sqd1.rowIndex, CELL_MAPPINGS.sqd.sqd1.colIndex);
            values.sqd2 = getCellValue(matrix, CELL_MAPPINGS.sqd.sqd2.rowIndex, CELL_MAPPINGS.sqd.sqd2.colIndex);
            values.sqd3 = getCellValue(matrix, CELL_MAPPINGS.sqd.sqd3.rowIndex, CELL_MAPPINGS.sqd.sqd3.colIndex);
            values.sqd4 = getCellValue(matrix, CELL_MAPPINGS.sqd.sqd4.rowIndex, CELL_MAPPINGS.sqd.sqd4.colIndex);
            values.sqd5 = getCellValue(matrix, CELL_MAPPINGS.sqd.sqd5.rowIndex, CELL_MAPPINGS.sqd.sqd5.colIndex);
            values.sqd6 = getCellValue(matrix, CELL_MAPPINGS.sqd.sqd6.rowIndex, CELL_MAPPINGS.sqd.sqd6.colIndex);
            values.sqd7 = getCellValue(matrix, CELL_MAPPINGS.sqd.sqd7.rowIndex, CELL_MAPPINGS.sqd.sqd7.colIndex);
            values.sqd8 = getCellValue(matrix, CELL_MAPPINGS.sqd.sqd8.rowIndex, CELL_MAPPINGS.sqd.sqd8.colIndex);
            values.sqdOverall = getCellValue(matrix, CELL_MAPPINGS.sqd.sqdOverall.rowIndex, CELL_MAPPINGS.sqd.sqdOverall.colIndex);
            
            return values;
        }

        // ----- Sample Data Generator (updated with SQD values) -----
        function generateSampleMatrix(type) {
            const m = [];
            for (let i = 0; i < 150; i++) m[i] = [];
            
            // Original sample data (kept exactly as before)
            m[42] = m[42] || []; 
            m[42][1] = type === 'external' ? 124 : type === 'internal' ? 98 : 222;
            m[42][2] = type === 'external' ? 146 : type === 'internal' ? 72 : 218;
            
            m[34] = m[34] || []; m[34][5] = 20;
            m[35] = m[35] || []; m[35][5] = 0;
            m[36] = m[36] || []; m[36][5] = 32;
            m[37] = m[37] || []; m[37][5] = 73;
            m[38] = m[38] || []; m[38][5] = 46;
            m[39] = m[39] || []; m[39][5] = 35;
            m[40] = m[40] || []; m[40][5] = 6;
            m[41] = m[41] || []; m[41][5] = 0;
            
            m[18] = m[18] || []; m[18][5] = 5;
            m[19] = m[19] || []; m[19][5] = type === 'external' ? 187 : type === 'internal' ? 64 : 251;
            m[20] = m[20] || []; m[20][5] = type === 'external' ? 62 : type === 'internal' ? 43 : 105;
            m[21] = m[21] || []; m[21][5] = type === 'external' ? 21 : type === 'internal' ? 63 : 84;
            
            m[26] = m[26] || []; m[26][7] = 4;
            m[27] = m[27] || []; m[27][7] = 78;
            m[28] = m[28] || []; m[28][7] = 94;
            m[29] = m[29] || []; m[29][7] = 112;
            
            m[47] = m[47] || []; m[47][5] = 6;
            m[48] = m[48] || []; m[48][5] = 103;
            m[49] = m[49] || []; m[49][5] = 47;
            m[50] = m[50] || []; m[50][5] = 58;
            m[51] = m[51] || []; m[51][5] = 32;
            
            m[57] = m[57] || []; m[57][5] = 7;
            m[58] = m[58] || []; m[58][5] = 89;
            m[59] = m[59] || []; m[59][5] = 52;
            m[60] = m[60] || []; m[60][5] = 23;
            m[61] = m[61] || []; m[61][5] = 14;
            m[62] = m[62] || []; m[62][5] = 41;
            
            m[68] = m[68] || []; m[68][5] = 5;
            m[69] = m[69] || []; m[69][5] = 112;
            m[70] = m[70] || []; m[70][5] = 58;
            m[71] = m[71] || []; m[71][5] = 16;
            m[72] = m[72] || []; m[72][5] = 27;
            
            // SQD SAMPLE VALUES (I109, I111-I119) - WITH 2 DECIMAL PLACES
            // Column I = index 8
            const baseSQD = type === 'external' ? 92.45 : type === 'internal' ? 88.75 : 90.25;
            m[109] = m[109] || []; m[109][8] = baseSQD; // SQD 0
            m[111] = m[111] || []; m[111][8] = 89.25; // SQD 1
            m[112] = m[112] || []; m[112][8] = 91.50; // SQD 2
            m[113] = m[113] || []; m[113][8] = 87.75; // SQD 3
            m[114] = m[114] || []; m[114][8] = 93.25; // SQD 4
            m[115] = m[115] || []; m[115][8] = 90.50; // SQD 5
            m[116] = m[116] || []; m[116][8] = 88.25; // SQD 6
            m[117] = m[117] || []; m[117][8] = 92.75; // SQD 7
            m[118] = m[118] || []; m[118][8] = 89.50; // SQD 8
            m[119] = m[119] || []; m[119][8] = 90.35; // Overall SQD
            
            return m;
        }

        // ----- Render Main Charts (original 7) -----
        function renderMainCharts(values) {
            const totalSex = values.male + values.female;
            const totalAge = values.ageNS + values.age19b + values.age2029 + values.age3039 + values.age4049 + values.age5059 + values.age6069 + values.age70;
            const totalClient = values.clientNS + values.citizen + values.business + values.government;
            const totalRegion = values.regionNS + values.region3 + values.region4a + values.ncr;
            const totalCC1 = values.cc1NS + values.knowSaw + values.knowNotSaw + values.learned + values.dontKnow;
            const awareDenom = totalCC1 - values.dontKnow - values.cc1NS || 1;

            let html = '';

            // Card 1: Sex Disaggregated Data
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-venus-mars"></i> Sex Disaggregated Data (SDD) by Service Type</h2>
                    <span class="total-indicator">Total: ${totalSex}</span>
                </div>
                <canvas id="chartSex"></canvas>
                <div class="data-legend">
                    <span>Male:</span> ${values.male} (${totalSex ? ((values.male/totalSex)*100).toFixed(2) : 0}%) 
                    <span>Female:</span> ${values.female} (${totalSex ? ((values.female/totalSex)*100).toFixed(2) : 0}%)
                </div>
            </div>`;

            // Card 2: Age Distribution
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-calendar-alt"></i> Age Distribution by Service Type</h2>
                    <span class="total-indicator">Total: ${totalAge}</span>
                </div>
                <canvas id="chartAge"></canvas>
                <div class="data-legend">
                    <div style="width: 100%; display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                        <div><span>Not Specified (N/S):</span> ${values.ageNS}</div>
                        <div><span>19 and below:</span> ${values.age19b}</div>
                        <div><span>20-29:</span> ${values.age2029}</div>
                        <div><span>30-39:</span> ${values.age3039}</div>
                        <div><span>40-49:</span> ${values.age4049}</div>
                        <div><span>50-59:</span> ${values.age5059}</div>
                        <div><span>60-69:</span> ${values.age6069}</div>
                        <div><span>70 and above:</span> ${values.age70}</div>
                    </div>
                </div>
            </div>`;

            // Card 3: Client Type
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-users"></i> Client Type by Service</h2>
                    <span class="total-indicator">Total: ${totalClient}</span>
                </div>
                <canvas id="chartClient"></canvas>
                <div class="data-legend">
                    <div><span>Not Specified (N/S):</span> ${values.clientNS}</div>
                    <div><span>Citizen (Mamamayan):</span> ${values.citizen}</div>
                    <div><span>Business (Negosyo):</span> ${values.business}</div>
                    <div><span>Government (Gobyerno):</span> ${values.government}</div>
                </div>
            </div>`;

            // Card 4: Client by Region
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-map-marker-alt"></i> Client by Region</h2>
                    <span class="total-indicator">Total: ${totalRegion}</span>
                </div>
                <canvas id="chartRegion"></canvas>
                <div class="data-legend">
                    <div><span>Not Specified (N/S):</span> ${values.regionNS}</div>
                    <div><span>Region III:</span> ${values.region3}</div>
                    <div><span>Region IV-A:</span> ${values.region4a}</div>
                    <div><span>NCR:</span> ${values.ncr}</div>
                </div>
            </div>`;

            // Card 5: CC1 Awareness
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-eye"></i> Citizen's Charter Awareness</h2>
                    <span class="total-indicator">Total: ${totalCC1}</span>
                </div>
                <canvas id="chartCC1"></canvas>
                <div class="data-legend">
                    <div><span>Not Specified (N/S):</span> ${values.cc1NS}</div>
                    <div><span>I know what a CC is and I saw this office’s CC:</span> ${values.knowSaw}</div>
                    <div><span>I know what a CC is but I did NOT see this office’s CC:</span> ${values.knowNotSaw}</div>
                    <div><span>I learned of the CC only when I saw this office’s CC:</span> ${values.learned}</div>
                    <div><span>I do not know what a CC is and I did not see one in this office:</span> ${values.dontKnow}</div>
                </div>
            </div>`;

            // Card 6: CC2 Visibility
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-low-vision"></i> Citizen's Charter Visibility</h2>
                    <span class="total-indicator">Aware respondents: ${awareDenom}</span>
                </div>
                <canvas id="chartCC2"></canvas>
                <div class="data-legend">
                    <div><span>Not Specified (N/S):</span> ${values.cc2NS}</div>
                    <div><span>Easy to see:</span> ${values.easy}</div>
                    <div><span>Somewhat easy to see:</span> ${values.somewhatEasy}</div>
                    <div><span>Difficult to see:</span> ${values.difficult}</div>
                    <div><span>Not visible at all:</span> ${values.notVisible}</div>
                    <div><span>N/A (Not Applicable):</span> ${values.cc2na}</div>
                </div>
            </div>`;

            // Card 7: CC3 Effectivity
            html += `<div class="chart-panel">
                <div class="chart-header">
                    <h2><i class="fas fa-check-circle"></i> Citizen's Charter Effectivity</h2>
                    <span class="total-indicator">Aware respondents: ${awareDenom}</span>
                </div>
                <canvas id="chartCC3"></canvas>
                <div class="data-legend">
                    <div><span>Not Specified (N/S):</span> ${values.cc3NS}</div>
                    <div><span>Helped very much:</span> ${values.helpedMuch}</div>
                    <div><span>Somewhat helped:</span> ${values.somewhatHelped}</div>
                    <div><span>Did not helped:</span> ${values.didNotHelp}</div>
                    <div><span>N/A (Not Applicable):</span> ${values.cc3na}</div>
                </div>
            </div>`;

            mainGridEl.innerHTML = html;

            // Destroy old charts
            Object.values(chartInstances).forEach(chart => chart?.destroy());
            chartInstances = {};

            // Blue & Gold Color Palette
            const bluePalette = ['#1a7f9e', '#2f98b3', '#45b0c9', '#7fc5d9', '#a8dae8'];
            const goldPalette = ['#c9a227', '#d9b44a', '#e5c36b', '#f0d59a', '#f8e7c4'];
            const lightBluePalette = ['#7fc5d9', '#a8dae8', '#c4e6f0', '#dff1f7', '#eef8fc'];

            // Create charts
            const chartConfigs = [
                { id: 'chartSex', type: 'doughnut', labels: ['Male', 'Female'], data: [values.male, values.female], colors: [bluePalette[0], goldPalette[0]] },
                { id: 'chartAge', type: 'bar', labels: ['N/S', '19↓', '20-29', '30-39', '40-49', '50-59', '60-69', '70↑'], data: [values.ageNS, values.age19b, values.age2029, values.age3039, values.age4049, values.age5059, values.age6069, values.age70], colors: bluePalette[1] },
                { id: 'chartClient', type: 'doughnut', labels: ['Citizen', 'Business', 'Government', 'N/S'], data: [values.citizen, values.business, values.government, values.clientNS], colors: [bluePalette[0], bluePalette[2], goldPalette[0], lightBluePalette[2]] },
                { id: 'chartRegion', type: 'pie', labels: ['Region III', 'Region IV-A', 'NCR', 'N/S'], data: [values.region3, values.region4a, values.ncr, values.regionNS], colors: [bluePalette[1], bluePalette[2], goldPalette[0], lightBluePalette[3]] },
                { id: 'chartCC1', type: 'bar', labels: ['Know & Saw', 'Know/Not Saw', 'Learned', 'Don\'t know', 'N/S'], data: [values.knowSaw, values.knowNotSaw, values.learned, values.dontKnow, values.cc1NS], colors: bluePalette[0] },
                { id: 'chartCC2', type: 'bar', labels: ['Easy', 'Somewhat', 'Difficult', 'Not visible', 'N/A', 'N/S'], data: [values.easy, values.somewhatEasy, values.difficult, values.notVisible, values.cc2na, values.cc2NS], colors: goldPalette[0] },
                { id: 'chartCC3', type: 'bar', labels: ['Helped much', 'Somewhat', 'Did not help', 'N/A', 'N/S'], data: [values.helpedMuch, values.somewhatHelped, values.didNotHelp, values.cc3na, values.cc3NS], colors: lightBluePalette[1] }
            ];

            chartConfigs.forEach(cfg => {
                const ctx = document.getElementById(cfg.id);
                if (!ctx) return;
                
                chartInstances[cfg.id] = new Chart(ctx, {
                    type: cfg.type,
                    data: {
                        labels: cfg.labels,
                        datasets: [{
                            data: cfg.data,
                            backgroundColor: cfg.colors,
                            borderWidth: 0,
                            borderRadius: cfg.type === 'bar' ? 6 : 0
                        }]
                    },
                    options: {
                        cutout: cfg.type === 'doughnut' ? '65%' : undefined,
                        scales: cfg.type === 'bar' ? { 
                            y: { beginAtZero: true, grid: { color: '#e9ecef' }, ticks: { color: '#2a5e6e' } },
                            x: { ticks: { color: '#2a5e6e' } }
                        } : undefined,
                        plugins: { legend: { display: false }, tooltip: { backgroundColor: '#0f859e', titleColor: 'white', bodyColor: 'white' } },
                        maintainAspectRatio: true
                    }
                });
            });
        }

        // ----- Render SQD Section (with 2 decimal places and cohesive chart) -----
        function renderSQDSection(values) {
            // Prepare SQD 1-8 data for the cohesive chart
            const sqdLabels = ['SQD 1', 'SQD 2', 'SQD 3', 'SQD 4', 'SQD 5', 'SQD 6', 'SQD 7', 'SQD 8'];
            const sqdFullLabels = [
                'Responsiveness',
                'Reliability',
                'Access & Facilities',
                'Communication',
                'Costs',
                'Integrity',
                'Assurance',
                'Outcome'
            ];
            const sqdData = [
                values.sqd1,
                values.sqd2,
                values.sqd3,
                values.sqd4,
                values.sqd5,
                values.sqd6,
                values.sqd7,
                values.sqd8
            ];

            // Build the 3-column layout
            let html = `
                <!-- SQD 0 - Overall Satisfaction -->
                <div class="percentage-card">
                    <h3><i class="fas fa-star" style="color: #c9a227; margin-right: 5px;"></i> SQD 0 - Overall Satisfaction</h3>
                    <div class="percentage-value">${values.sqd0.toFixed(2)}%</div>
                    <div class="percentage-label">Satisfaction Rating</div>
                </div>
                
                <!-- SQD 1-8 Cohesive Chart -->
                <div class="sqd-chart-panel">
                    <div class="sqd-chart-header">
                        <h2><i class="fas fa-chart-bar"></i> SQD 1-8: Service Quality Dimensions</h2>
                        <span class="total-indicator">8 Dimensions</span>
                    </div>
                    <canvas id="chartSQD1to8"></canvas>
                    <div class="data-legend" style="margin-top: 0.8rem; padding: 0.8rem; font-size: 0.7rem;">
                        ${sqdFullLabels.map((label, index) => `<span>${label}:</span> ${sqdData[index].toFixed(2)}%`).join(' · ')}
                    </div>
                </div>
                
                <!-- Overall SQD (1-8) -->
                <div class="percentage-card">
                    <h3><i class="fas fa-chart-pie" style="color: #c9a227; margin-right: 5px;"></i> Overall SQD (1-8)</h3>
                    <div class="percentage-value">${values.sqdOverall.toFixed(2)}%</div>
                    <div class="percentage-label">Average Satisfaction</div>
                </div>
            `;

            sqdChartsContainer.innerHTML = html;

            // Create the SQD 1-8 bar chart
            const ctx = document.getElementById('chartSQD1to8');
            if (ctx) {
                // Blue gradient for bars
                const bluePalette = ['#1a7f9e', '#2f98b3', '#45b0c9', '#7fc5d9', '#a8dae8'];
                
                chartInstances.sqdChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sqdLabels,
                        datasets: [{
                            label: 'Satisfaction Percentage',
                            data: sqdData,
                            backgroundColor: bluePalette[0],
                            borderRadius: 6,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#0f859e',
                                titleColor: 'white',
                                bodyColor: 'white',
                                callbacks: {
                                    label: function(context) {
                                        return `${sqdFullLabels[context.dataIndex]}: ${context.raw.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                grid: { color: '#e9ecef' },
                                ticks: { 
                                    color: '#2a5e6e',
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            x: {
                                ticks: { color: '#2a5e6e' }
                            }
                        }
                    }
                });
            }
        }

        // ----- Render Dashboard -----
        async function renderDashboard() {
            // Show loading state
            const loadingHTML = `
                <div class="loading-state">
                    <i class="fas fa-spinner fa-pulse" style="font-size: 2rem; color: #c9a227; margin-bottom: 1rem;"></i>
                    <p style="color: #0f859e; font-weight: 500;">Loading ${currentService.toLowerCase()} client satisfaction data...</p>
                </div>
            `;
            mainGridEl.innerHTML = loadingHTML;
            sqdChartsContainer.innerHTML = '';

            const matrix = await fetchSheetData(currentService);
            const values = readAllCells(matrix);
            
            // Render all sections
            renderMainCharts(values);
            renderSQDSection(values);
        }

        // ----- Event Listeners -----
        function initEvents() {
            document.querySelectorAll('.switch-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.switch-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentService = this.dataset.type;
                    renderDashboard();
                });
            });
        }

        // ----- Start -----
        window.addEventListener('DOMContentLoaded', () => {
            initEvents();
            renderDashboard();
        });
    })();
</script>
</body>
</html>
